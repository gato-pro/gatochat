<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Global Chat — Reply & Delete</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0a1220;
    --muted:#9aa8bb;
    --accent1: #090909; /* message color in gradient*/
    --accent2: #070707;
    --reply-border: #7c3aed;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter}
  .app{display:flex;flex-direction:column;height:100dvh}
  .header{padding:16px;background:rgba(255,255,255,0.03);font-weight:700;display:flex;align-items:center;gap:16px}
  .back{cursor:pointer;color:#9bd;background:none;border:none}
  .messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
  .msg{max-width:75%;padding:12px;border-radius:12px;background:rgba(255,255,255,0.05);position:relative;word-break:break-word}
  .msg.me{align-self:flex-end;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .composeWrap{padding:10px;background:rgba(255,255,255,0.02)}
  .replyPreview{
    display:flex;align-items:flex-start;gap:8px;padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
  }
  .replyBar{
    width:4px;border-radius:2px;background:var(--reply-border);flex:0 0 4px;margin-right:6px;
  }
  .replyContent{flex:1;font-size:13px;color:var(--muted)}
  .replyName{font-weight:600;color:#fff;font-size:13px;margin-bottom:4px}
  .replyText{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
  .replyCancel{background:none;border:none;color:var(--muted);cursor:pointer;padding:6px}
  .compose{display:flex;gap:8px;align-items:center}
  .input{flex:1;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.08);color:white;min-height:42px}
  .send{padding:10px 16px;border-radius:8px;background:transparent;border:none;color:white;cursor:pointer}
  .ctxMenu {
    position:fixed;
    z-index:9999;
    background:rgba(18,18,25,0.98);
    border:1px solid rgba(255,255,255,0.04);
    padding:6px;
    border-radius:8px;
    box-shadow:0 6px 30px rgba(0,0,0,0.6);
    display:flex;
    flex-direction:column;
    min-width:140px;
  }
  .ctxItem {
    padding:10px 12px;
    cursor:pointer;
    border-radius:6px;
    color:#fff;
    font-size:14px;
    user-select:none;
    background:transparent;
    text-align:left;
    border:none;
  }
  .ctxItem:hover{background:rgba(255,255,255,0.02)}
  .ctxItem.delete{color:#ff7b7b}
  /* small visual for longpress */
  .msg.longpressing { outline:2px solid rgba(255,255,255,0.04); transform:scale(0.998); }

  @media (max-width:600px){ .msg{max-width:90%} .replyText{max-width:160px} }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <button class="back" onclick="location.href='members.html'">←</button>
    Global Chat
  </div>

  <div id="messages" class="messages"></div>

  <div class="composeWrap">
    <!-- Reply preview (hidden unless replying) -->
    <div id="replyPreview" class="replyPreview" style="display:none;">
      <div class="replyBar"></div>
      <div style="flex:1">
        <div class="replyName" id="replyName"></div>
        <div class="replyText" id="replyText"></div>
      </div>
      <button id="cancelReply" class="replyCancel">✕</button>
    </div>

    <div class="compose">
      <textarea id="text" class="input" placeholder="Type message..." rows="1"></textarea>
      <button id="btnSend" class="send">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M9.61109 12.4L10.8183 18.5355C11.0462 19.6939 12.6026 19.9244 13.1565 18.8818L19.0211 7.84263C19.248 7.41555 19.2006 6.94354 18.9737 6.58417M9.61109 12.4L5.22642 8.15534C4.41653 7.37131 4.97155 6 6.09877 6H17.9135C18.3758 6 18.7568 6.24061 18.9737 6.58417M9.61109 12.4L18.9737 6.58417M19.0555 6.53333L18.9737 6.58417" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
  </svg>
      </button>
    </div>
  </div>
</div>

<!-- Firebase compat scripts -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* ================== CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBdhQFVF0PTZMw0DXT5zBLpxndw_HNSv5U",
  authDomain:"gatochat-56ab6.firebaseapp.com",
  databaseURL:"https://gatochat-56ab6-default-rtdb.firebaseio.com",
  projectId:"gatochat-56ab6",
  storageBucket:"gatochat-56ab6.firebasestorage.app",
  messagingSenderId:"888124564246",
  appId:"1:888124564246:web:33a41ee68eec0f6b9c2637"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
/* ============================================ */

let currentUser = null;
let replyingTo = null; // { id, name, text }
const userMap = new Map();
let presenceListenerAttached = false;

/* ================= AUTH CHECK ================= */
auth.onAuthStateChanged(user => {
  if (!user) return location.href = 'login.html';
  currentUser = user;

  // initialize presence
  initPresence(user);

  // initialize current page
  if (window.location.pathname.endsWith("chat.html")) initChat(user);
  else if (window.location.pathname.endsWith("members.html")) renderUsersPage(user);
  else if (window.location.pathname.endsWith("global.html")) initGlobal(user);
});

/* ================== PRESENCE ================== */
function initPresence(user) {
  const uid = user.uid;
  const presenceRef = db.ref("presence/" + uid);
  const connectedRef = db.ref(".info/connected");

  connectedRef.on("value", snap => {
    if (snap.val() === true) {
      // mark online
      presenceRef.set({ online:true, lastSeen:Date.now(), name:user.displayName || "" });
      // automatically mark offline if disconnected
      presenceRef.onDisconnect().set({ online:false, lastSeen:Date.now(), name:user.displayName || "" });
    }
  });

  // heartbeat to refresh lastSeen every 30s
  setInterval(() => presenceRef.update({ lastSeen: Date.now() }), 30_000);
}

/* ================== GLOBAL CHAT ================== */
function initGlobal(user){
  const msgEl = document.getElementById("messages");
  const textInput = document.getElementById("text");
  const sendBtn = document.getElementById("btnSend");

  const rendered = new Set();

  // Load last 50 messages
  db.ref("global/messages").limitToLast(50).orderByChild('time').once("value").then(snap=>{
    msgEl.innerHTML = '';
    snap.forEach(child => {
      const id = child.key;
      renderMessage(id, child.val(), user.uid, rendered);
    });
    msgEl.scrollTop = msgEl.scrollHeight;
  });

  // Realtime child_added
  db.ref("global/messages").limitToLast(50).orderByChild('time').on("child_added", snap=>{
    const id = snap.key;
    if (rendered.has(id)) return;
    renderMessage(id, snap.val(), user.uid, rendered);
    setTimeout(()=> msgEl.scrollTop = msgEl.scrollHeight, 50);
  });

  // child_removed
  db.ref("global/messages").on("child_removed", snap => {
    const el = document.querySelector(`[data-msgid="${snap.key}"]`);
    if (el) {
      const placeholder = document.createElement('div');
      placeholder.className = 'msg';
      placeholder.style.maxWidth = '60%';
      placeholder.style.background = 'rgba(255,255,255,0.02)';
      placeholder.style.color = '#9aa8bb';
      placeholder.innerHTML = `<div class="meta">${new Date().toLocaleTimeString()}</div><div>Message deleted</div>`;
      el.replaceWith(placeholder);
    }
    rendered.delete(snap.key);
  });

  // send message
  sendBtn.onclick = () => sendMessage(user, textInput);
  textInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(user, textInput);
    }
  });

  document.getElementById('cancelReply').addEventListener('click', clearReplyPreview);
}

/* ================== SEND MESSAGE ================== */
function sendMessage(user, textInput){
  const txt = textInput.value.trim();
  if (!txt) return;

  const payload = {
    uid: user.uid,
    name: user.displayName || 'User',
    text: txt,
    time: Date.now()
  };

  if (replyingTo) {
    payload.reply = { id: replyingTo.id, name: replyingTo.name, text: replyingTo.text };
  }

  db.ref("global/messages").push(payload)
    .then(()=> { textInput.value=''; clearReplyPreview(); })
    .catch(err=> { console.error(err); alert("Send failed"); });
}

/* ================== RENDER MESSAGE ================== */
function renderMessage(id, m, myUid, renderedSet){
  const messagesEl = document.getElementById("messages");
  const div = document.createElement('div');
  div.className = 'msg' + (m.uid === myUid ? ' me' : '');
  div.setAttribute('data-msgid', id);

  let replyHtml = '';
  if (m.reply && m.reply.text){
    replyHtml = `<div style="border-left:3px solid #4da3ff;padding-left:10px;margin-bottom:6px;">
      <div style="font-weight:600;color:#4da3ff;font-size:13px;margin-bottom:2px;">
        ${escape(m.reply.name || 'Unknown')}
      </div>
      <div style="color:var(--muted);font-size:13px;max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        ${escape(m.reply.text)}
      </div>
    </div>`;
  }

  const textHtml = `<div class="text">${escape(m.text || '')}</div>`;
  const meta = `<div class="meta">${escape(m.name || 'User')} — ${new Date(m.time || Date.now()).toLocaleTimeString()}</div>`;
  div.innerHTML = `${meta}${replyHtml}${textHtml}`;

  enableLongPressAndContext(div, id, m, myUid);

  messagesEl.appendChild(div);
  renderedSet && renderedSet.add(id);
}

/* ================== LONG PRESS / CONTEXT ================== */
function enableLongPressAndContext(el, msgId, messageData, myUid){
  let timer=null, longPressed=false, LONG_MS=600;

  const start = (x,y)=>{ timer=setTimeout(()=>{ longPressed=true; el.classList.add('longpressing'); showActionMenu(x,y,msgId,messageData,myUid); }, LONG_MS); };
  const cancel = ()=>{ if(timer) clearTimeout(timer); timer=null; if(longPressed){longPressed=false; el.classList.remove('longpressing');}};

  el.addEventListener('touchstart', e=>{ const t=e.touches[0]; if(t) start(t.clientX,t.clientY); }, {passive:true});
  el.addEventListener('touchend', cancel); el.addEventListener('touchmove', cancel); el.addEventListener('touchcancel', cancel);
  el.addEventListener('contextmenu', e=>{ e.preventDefault(); showActionMenu(e.clientX,e.clientY,msgId,messageData,myUid); return false; });
  el.addEventListener('mousedown', e=>{ if(e.button!==0) return; start(e.clientX,e.clientY); });
  el.addEventListener('mouseup', cancel); el.addEventListener('mouseleave', cancel);
}

let activeCtx = null;
function showActionMenu(x,y,msgId,messageData,myUid){
  hideActionMenu();
  const menu=document.createElement('div'); menu.className='ctxMenu';
  menu.style.left=(x+6)+'px'; menu.style.top=(y+6)+'px';

  const replyBtn=document.createElement('button'); replyBtn.className='ctxItem'; replyBtn.innerText='Reply';
  replyBtn.onclick=()=>{ hideActionMenu(); openReplyPreview(msgId,messageData); }; menu.appendChild(replyBtn);

  if(messageData.uid===myUid){
    const delBtn=document.createElement('button'); delBtn.className='ctxItem delete'; delBtn.innerText='Delete';
    delBtn.onclick=async()=>{ hideActionMenu(); if(confirm("Delete this message?")) await db.ref("global/messages/"+msgId).remove(); };
    menu.appendChild(delBtn);
  }

  const cancelBtn=document.createElement('button'); cancelBtn.className='ctxItem'; cancelBtn.innerText='Cancel'; cancelBtn.onclick=hideActionMenu;
  menu.appendChild(cancelBtn);

  document.body.appendChild(menu);
  activeCtx=menu;
  const rect=menu.getBoundingClientRect(), vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0), vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0);
  if(rect.right>vw) menu.style.left=(vw-rect.width-12)+'px'; if(rect.bottom>vh) menu.style.top=(vh-rect.height-12)+'px';
  setTimeout(()=>{ window.addEventListener('click',outsideClickClose); window.addEventListener('resize',hideActionMenu); window.addEventListener('scroll',hideActionMenu,true); },50);
}
function hideActionMenu(){ if(activeCtx){ activeCtx.remove(); activeCtx=null; window.removeEventListener('click',outsideClickClose); window.removeEventListener('resize',hideActionMenu); window.removeEventListener('scroll',hideActionMenu,true); document.querySelectorAll('.msg.longpressing').forEach(el=>el.classList.remove('longpressing')); } }
function outsideClickClose(e){ if(!activeCtx) return; if(!activeCtx.contains(e.target)) hideActionMenu(); }

/* ================== REPLY PREVIEW ================== */
function openReplyPreview(msgId,messageData){
  if(!messageData) return;
  replyingTo={ id:msgId, name:messageData.name||'Unknown', text:(messageData.text||'').slice(0,300) };
  document.getElementById('replyName').innerText=replyingTo.name;
  document.getElementById('replyText').innerText=replyingTo.text;
  document.getElementById('replyPreview').style.display='flex';
  document.getElementById('text').focus();
}
function clearReplyPreview(){ replyingTo=null; document.getElementById('replyPreview').style.display='none'; document.getElementById('replyName').innerText=''; document.getElementById('replyText').innerText=''; }

/* ================== MEMBERS LIST (RENDER USERS) ================== */
function renderUsersPage(user){
  db.ref("users").once("value").then(snap=>{
    const users = snap.val() || {};
    renderUsers(users, user.uid);
  });
}

function renderUsers(users, myUid){
  const membersList = document.getElementById("membersList");
  const search = document.getElementById("search");

  // Remove non-existing
  const activeUids = new Set(Object.keys(users));
  for(const [uid, rec] of Array.from(userMap.entries())){
    if(!activeUids.has(uid)){
      if(rec.listeners) rec.listeners.forEach(l=>l.ref.off('child_added',l.cb));
      rec.el && rec.el.remove(); userMap.delete(uid);
    }
  }

  // Add/update
  Object.keys(users).forEach(uid=>{
    if(uid===myUid) return;
    const u=users[uid]||{}, name=u.name||"Unknown", photo=u.photo||"";
    if(userMap.has(uid)){
      const rec=userMap.get(uid);
      rec.el.querySelector(".name").textContent=name;
      rec.el.querySelector(".avatar").innerHTML = photo ? `<img src="${photo}" alt="avatar">` : (name[0]||"?").toUpperCase();
      const previewEl = rec.el.querySelector(".preview");
      loadLastMessage(uid, previewEl, rec);
      return;
    }

    const div=document.createElement("div"); div.className="user"; div.dataset.name=name.toLowerCase(); div.dataset.uid=uid;
    div.innerHTML = `<div class="avatar">${photo?`<img src="${photo}" alt="avatar">`:(name[0]||"?").toUpperCase()}</div>
      <div style="flex:1;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="name">${name}</div>
          <div class="meta-time" id="time-${uid}"></div>
        </div>
        <div class="preview" id="preview-${uid}">No messages yet</div>
      </div>
      <button class="openChat" data-uid="${uid}" style="background:#06b6d4;border:none;padding:6px 10px;border-radius:8px;color:#012">Chat</button>`;
    membersList.appendChild(div);

    const rec = { el:div, lastTime:0, listeners:[] };
    rec.timeEl = div.querySelector(".meta-time"); userMap.set(uid, rec);

    div.querySelector(".openChat").onclick=e=>{ e.stopPropagation(); openChatWith(uid); };
    div.onclick=e=>{ if(!e.target.closest('.openChat')) openChatWith(uid); };

    const previewEl=div.querySelector(".preview");
    loadLastMessage(uid, previewEl, rec);
    attachLivePreviewListeners(uid, rec);
  });

  // Presence listener
  if(!presenceListenerAttached){
    presenceListenerAttached=true;
    db.ref("presence").on("value", snap=>{
      const pres = snap.val() || {};
      Object.keys(pres).forEach(uid=>{
        const rec=userMap.get(uid);
        if(!rec || !rec.timeEl) return;
        rec.timeEl.textContent = pres[uid].online ? "Online" : "Last seen "+new Date(pres[uid].lastSeen||Date.now()).toLocaleTimeString();
      });
    });
  }

  // Sort by last message
  const sortedUsers = Object.keys(users).filter(uid=>uid!==myUid).sort((a,b)=>{
    const aTime=userMap.get(a)?.lastTime||0, bTime=userMap.get(b)?.lastTime||0;
    return bTime-aTime;
  });
  sortedUsers.forEach(uid=>{ const rec=userMap.get(uid); if(rec && rec.el && rec.el.parentNode) membersList.appendChild(rec.el); });

  search.dispatchEvent(new Event('input'));
}

/* ================== LAST MESSAGE ================== */
function loadLastMessage(uid, previewEl, rec){
  db.ref("messages").child(uid).limitToLast(1).once("value").then(snap=>{
    const msgData = snap.val();
    if(!msgData){ previewEl.textContent="No messages yet"; rec.lastTime=0; return; }
    const lastMsgKey = Object.keys(msgData)[0];
    const lastMsg = msgData[lastMsgKey];
    previewEl.textContent = lastMsg.text||"No messages yet";
    rec.lastTime = lastMsg.timestamp||0;
  });
}

function attachLivePreviewListeners(uid, rec){
  const cb = db.ref("messages").child(uid).limitToLast(1).on("child_added", snap=>{
    const msg = snap.val(); if(!msg) return;
    const previewEl = rec.el.querySelector(".preview");
    previewEl.textContent = msg.text || "No messages yet";
    rec.lastTime = msg.timestamp || 0;
  });
  rec.listeners.push({ ref: db.ref("messages").child(uid), cb });
}

/* ================== UTILS ================== */
function escape(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
document.addEventListener('contextmenu',e=>{ const tag=(e.target&&e.target.tagName||'').toLowerCase(); if(tag==='input'||tag==='textarea'||e.target.isContentEditable) return; e.preventDefault(); }, {passive:false});

</script>
</body>
</html>

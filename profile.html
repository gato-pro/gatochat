<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Edit Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<!-- Cropper.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

<style>
  body {
      margin:0;
      background:#071428;
      color:#fff;
      font-family:Inter,Arial;
      padding:20px;
      overflow-x:hidden;
  }

  .card {
      max-width:420px;
      margin:20px auto;
      background:rgba(255,255,255,0.03);
      padding:20px;
      border-radius:12px;
  }

  .picBox {
      width:140px;
      height:140px;
      border-radius:50%;
      background:#111;
      margin:0 auto 14px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
  }

  .picBox img {
      width:100%;
      height:100%;
      object-fit:cover;
  }

  input,button {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.05);
      background:transparent;
      color:#fff;
      margin-top:10px;
  }

  .row {
      display:flex;
      gap:10px;
  }

  .btnPrimary {
      background:#3da2ea;
      border:none;
      color:#060606;
      font-weight:700;
  }

  .btnDanger {
      background:#c30707;
      border:none;
      color:#d4d4d4;
      font-weight: 700;
  }

  label.fileLabel {
      display:block;
      text-align:center;
      cursor:pointer;
  }

  #fileInput {
      display:none;
  }

  /* WHATSAPP STYLE CROP MODAL */
  #cropModal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      display:none;
      justify-content:center;
      align-items:center;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(8px);
      z-index:1000;
      padding:20px;
      animation:slideUp 0.25s ease-out;
  }

  @keyframes slideUp {
      from { transform:translateY(40px); opacity:0; }
      to { transform:translateY(0); opacity:1; }
  }

  .cropBox {
      background:#0c0f18;
      padding:18px;
      border-radius:18px;
      max-width:90vw;
      max-height:80vh;
      box-shadow:0 0 18px rgba(0,0,0,0.4);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
  }

  #cropImage {
      max-width:100%;
      max-height:60vh;
      object-fit:contain;
      border-radius:10px;
  }

  .cropBtns {
      width:100%;
      display:flex;
      gap:12px;
      margin-top:18px;
  }

  .cropBtns button {
      flex:1;
      padding:12px;
      border-radius:8px;
      border:none;
      font-weight:700;
      cursor:pointer;
      font-size:15px;
  }

  .cropCancel { background:#c30707; color:#111 }
  .cropSave   { background:#3da2ea; color:#001 }

  /* Loading overlay */
  #loadingOverlay {
      position:fixed;
      left:0;
      top:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      color:#fff;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:18px;
      z-index:2000;
  }

</style>
</head>

<body>

<div class="card">
  <h2 style="margin:0 0 12px 0">Edit Profile</h2>

  <div class="picBox">
    <img id="profilePic" src="https://via.placeholder.com/300x300?text=Avatar">
  </div>

  <label class="fileLabel btnPrimary" for="fileInput">Choose New Photo</label>
  <input type="file" id="fileInput" accept="image/*">

  <input id="nameInput" placeholder="Display name" />

  <div class="row">
    <button id="saveBtn" class="btnPrimary">Save Profile</button>
    <button id="signOut" class="btnDanger">Sign out</button>
  </div>
</div>

<!-- Crop Modal -->
<div id="cropModal">
  <div class="cropBox">
      <img id="cropImage">
      <div class="cropBtns">
          <button class="cropCancel" id="cancelCrop">Cancel</button>
          <button class="cropSave" id="saveCrop">Crop & Save</button>
      </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBdhQFVF0PTZMw0DXT5zBLpxndw_HNSv5U",
  authDomain: "gatochat-56ab6.firebaseapp.com",
  databaseURL: "https://gatochat-56ab6-default-rtdb.firebaseio.com",
  projectId: "gatochat-56ab6",
  storageBucket: "gatochat-56ab6.firebasestorage.app",
  messagingSenderId: "888124564246",
  appId: "1:888124564246:web:33a41ee68eec0f6b9c2637"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const IMGBB_KEY = "9de61cf69da55fffd9fc05998c9acadd";

let currentUser = null;
let cropper = null;
let croppedBlob = null;

/* Elements */
const profilePic = document.getElementById("profilePic");
const nameInput  = document.getElementById("nameInput");
const fileInput  = document.getElementById("fileInput");
const cropModal  = document.getElementById("cropModal");
const cropImage  = document.getElementById("cropImage");
const saveBtn = document.getElementById('saveBtn');
const signOutBtn = document.getElementById('signOut');

// Create lightweight loading overlay if not present
if (!document.getElementById('loadingOverlay')){
  const ol = document.createElement('div');
  ol.id = 'loadingOverlay';
  ol.style.cssText = 'position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);color:#fff;display:none;align-items:center;justify-content:center;font-size:18px;z-index:2000';
  ol.textContent = 'Loading...';
  document.body.appendChild(ol);
}
function showLoading(msg='Loading...'){
  const el = document.getElementById('loadingOverlay');
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'flex';
}
function hideLoading(){ const el = document.getElementById('loadingOverlay'); if (el) el.style.display = 'none'; }

/* Load profile (with caching & preloading) */
auth.onAuthStateChanged(async user => {
    if (!user) return location.href = "login.html";
    currentUser = user;

    // initialize presence so this user shows online while on profile page
    initPresence(user);

    showLoading('Loading profile...');
    try{
        const cacheKey = 'photoCache_' + user.uid;
        let cached = null;
        try{ cached = JSON.parse(localStorage.getItem(cacheKey)); }catch(e){ cached = null; }

        const snap = await db.ref("users/" + user.uid).once("value");
        const data = snap.val() || {};
        if (data.name)  nameInput.value = data.name;

        const remotePhoto = data.photo;
        // prefer cached url if same as remote and not too old (24h)
        if (remotePhoto){
            if (cached && cached.url === remotePhoto && (Date.now() - (cached.ts||0)) < 24*3600*1000){
                profilePic.src = cached.url;
            } else {
                // preload remote image to avoid showing a broken or half-rendered image
                await new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => { try{ profilePic.src = remotePhoto; localStorage.setItem(cacheKey, JSON.stringify({url: remotePhoto, ts: Date.now()})); }catch(e){}; resolve(); };
                    img.onerror = () => { resolve(); };
                    img.src = remotePhoto;
                });
            }
        } else if (cached && cached.url){
            profilePic.src = cached.url; // fallback to cached image
        }
    }catch(err){
        console.error('Failed to load profile', err);
    }finally{
        hideLoading();
    }
});

// Presence helpers: ensure user is marked online while on this page
function initPresence(user){
    if (!user || !user.uid) return;
    const uid = user.uid;
    const presenceRef = db.ref('presence/' + uid);
    const connectedRef = db.ref('.info/connected');

    connectedRef.on('value', snap => {
        if (snap.val() === true) {
            // set online immediately
            presenceRef.set({ online:true, lastSeen:Date.now(), name: user.displayName||'' }).catch(()=>{});
            // ensure we set offline on disconnect
            presenceRef.onDisconnect().set({ online:false, lastSeen:Date.now(), name: user.displayName||'' }).catch(()=>{});
        }
    });

    // keep lastSeen updated every 30 seconds while the page is open
    try{
        setInterval(()=>{
            presenceRef.update({ lastSeen: Date.now() }).catch(()=>{});
        }, 1000);
    }catch(e){/* ignore */}
}

/* Choose photo â†’ open crop modal */
fileInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    cropImage.src = URL.createObjectURL(file);
    cropModal.style.display = "flex";

    if (cropper){ try{ cropper.destroy(); }catch(e){} }

    cropper = new Cropper(cropImage, {
        aspectRatio: 1,
        viewMode: 1,
        dragMode: "move",
        background: false,
        autoCropArea: 1,
        responsive: true,
        zoomOnTouch: true,
        zoomOnWheel: true
    });
};

/* Cancel crop */
document.getElementById("cancelCrop").onclick = () => {
    if (cropper){ try{ cropper.destroy(); }catch(e){} }
    cropModal.style.display = "none";
};

/* Crop & preview */
document.getElementById("saveCrop").onclick = async () => {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({
        width: 400, height: 400, imageSmoothingQuality: "high"
    });

    canvas.toBlob(blob => {
        if (!blob) return;
        croppedBlob = blob;
        profilePic.src = URL.createObjectURL(blob);
        cropModal.style.display = "none";
        try{ cropper.destroy(); }catch(e){}
    }, "image/jpeg", 0.85); // slightly lower quality for faster uploads
};

/* Upload to ImgBB */
async function uploadToImgBB(blob) {
    showLoading('Uploading photo...');
    try{
        const form = new FormData();
        form.append("image", blob);

        const req = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
            method: "POST",
            body: form
        });

        const json = await req.json();
        return json && json.data && json.data.url ? json.data.url : null;
    }catch(err){
        console.error('Upload failed', err);
        return null;
    }finally{
        hideLoading();
    }
}

/* Save profile */
document.getElementById("saveBtn").onclick = async () => {
    if (!currentUser) return alert('Not signed in');

    // disable buttons to prevent duplicate actions
    saveBtn.disabled = true;
    signOutBtn.disabled = true;

    showLoading('Saving profile...');
    try{
        const updates = {};
        if (nameInput.value.trim()) updates.name = nameInput.value.trim();

        if (croppedBlob){
            const uploaded = await uploadToImgBB(croppedBlob);
            if (uploaded) {
                updates.photo = uploaded;
                // cache the uploaded image locally for faster next load
                try{ localStorage.setItem('photoCache_' + currentUser.uid, JSON.stringify({url: uploaded, ts: Date.now()})); }catch(e){}
            } else {
                alert('Image upload failed. Try again.');
            }
        }

        // perform DB update
        await db.ref("users/" + currentUser.uid).update(updates);

        alert("Profile saved!");
        location.href = "members.html";
    }catch(err){
        console.error('Save failed', err);
        alert('Failed to save profile.');
    }finally{
        hideLoading();
        saveBtn.disabled = false;
        signOutBtn.disabled = false;
    }
};



/* Logout */
document.getElementById("signOut").onclick = async () => {
    await auth.signOut();
    location.href = "index.html";
};
</script>

</body>
<!-- created by @surajdasop69 -->
</html>

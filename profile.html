<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Edit Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{margin:0;background:#071428;color:#fff;font-family:Inter,Arial;padding:20px}
  .card{max-width:420px;margin:32px auto;background:rgba(255,255,255,0.02);padding:20px;border-radius:12px}
  .picBox{width:140px;height:140px;border-radius:50%;background:#111;margin:0 auto 14px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .picBox img{width:100%;height:100%;object-fit:cover}
  input,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin-top:8px}
  .row{display:flex;gap:8px}
  .btnPrimary{background:#06b6d4;border:none;color:#012;font-weight:700}
  .btnDanger{background:#ef4444;border:none}
  .small{font-size:13px;color:#9aa8bb;margin-top:8px}
  label.fileLabel{display:block;text-align:center;cursor:pointer}
  #fileInput{display:none}
</style>
</head>
<body>

<div class="card">
  <h2 style="margin:0 0 12px 0">Edit Profile</h2>

  <div class="picBox" id="profilePicHolder">
    <img id="profilePic" src="https://via.placeholder.com/300x300?text=Avatar" alt="avatar">
  </div>

  <label class="fileLabel btnPrimary" for="fileInput">Choose New Photo</label>
  <input type="file" id="fileInput" accept="image/*">

  <input id="nameInput" placeholder="Display name" />
  <div class="row">
    <button id="saveBtn" class="btnPrimary" style="flex:1">Save Profile</button>
    <button id="signOut" class="btnDanger" style="flex:1">Sign out</button>
  </div>

  <div class="small">Photos are uploaded to ImgBB (public). Replace key in this file if you want to rotate the API key.</div>
</div>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBdhQFVF0PTZMw0DXT5zBLpxndw_HNSv5U",
  authDomain: "gatochat-56ab6.firebaseapp.com",
  databaseURL: "https://gatochat-56ab6-default-rtdb.firebaseio.com",
  projectId: "gatochat-56ab6",
  storageBucket: "gatochat-56ab6.firebasestorage.app",
  messagingSenderId: "888124564246",
  appId: "1:888124564246:web:33a41ee68eec0f6b9c2637"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ---------------- IMGBB KEY ---------------- */
const IMGBB_KEY = "9de61cf69da55fffd9fc05998c9acadd";

/* ---------------- DOM ELEMENTS ---------------- */
const nameInput = document.getElementById('nameInput');
const profilePic = document.getElementById('profilePic');
const fileInput = document.getElementById('fileInput');
const saveBtn = document.getElementById('saveBtn');
const signOutBtn = document.getElementById('signOut');
const statusEl = document.getElementById('onlineStatus'); // add this in your HTML to show online/offline

let currentUser = null;
let uploadedUrl = null;
let presenceRef = null;

/* ---------------- AUTH & INIT ---------------- */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = 'login.html';
  currentUser = user;

  // Init presence tracking
  initPresence(user);

  // Load profile info once
  const snap = await db.ref('users/' + user.uid).once('value');
  const data = snap.val() || {};
  if (data.name) nameInput.value = data.name;
  if (data.photo) profilePic.src = data.photo;
});

/* ---------------- PRESENCE TRACKING ---------------- */
function initPresence(user){
  const uid = user.uid;
  presenceRef = db.ref('presence/' + uid);
  const connectedRef = db.ref('.info/connected');

  connectedRef.on('value', snap => {
    if (snap.val() === true) {
      presenceRef.set({ online:true, lastSeen:Date.now(), name:user.displayName||'' });
      presenceRef.onDisconnect().set({ online:false, lastSeen:Date.now(), name:user.displayName||'' });
      updateStatus(true);
    } else {
      updateStatus(false);
    }
  });

  // Update lastSeen periodically while page is open
  setInterval(() => {
    presenceRef?.update({ lastSeen: Date.now(), online:true });
  }, 30_000); // every 30 seconds
}

// Show online/offline in profile page
function updateStatus(isOnline){
  if (!statusEl) return;
  statusEl.textContent = isOnline ? "Online" : "Offline";
  statusEl.style.color = isOnline ? "green" : "red";
}

/* ---------------- UPLOAD IMAGE ---------------- */
fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;
  try {
    profilePic.style.filter = 'grayscale(80%)';
    const url = await uploadToImgBB(file);
    uploadedUrl = url;
    profilePic.src = url;
    profilePic.style.filter = '';
    alert('Upload successful. Click Save Profile to persist.');
  } catch (err) {
    console.error('Upload error', err);
    alert('Upload failed: ' + err.message);
    profilePic.style.filter = '';
  }
});

async function uploadToImgBB(file){
  const form = new FormData();
  form.append('image', file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method:'POST', body:form });
  const json = await res.json();
  if (!json || !json.success) throw new Error(json?.error?.message || 'ImgBB upload failed');
  return json.data.url;
}

/* ---------------- SAVE PROFILE ---------------- */
saveBtn.addEventListener('click', async () => {
  if (!currentUser) return alert('Not signed in.');
  const name = (nameInput.value || '').trim();
  const updates = {};
  if (name) updates.name = name;
  if (uploadedUrl) updates.photo = uploadedUrl;
  if (Object.keys(updates).length === 0) return alert('Nothing to save.');

  try {
    await db.ref('users/' + currentUser.uid).update(updates);
    if (name) await currentUser.updateProfile({ displayName:name }).catch(()=>{});
    alert('Profile saved.');
    location.href = 'members.html';
  } catch (err) {
    console.error('Save failed', err);
    alert('Save failed: ' + err.message);
  }
});

/* ---------------- SIGN OUT ---------------- */
signOutBtn.addEventListener('click', async () => {
  await auth.signOut();
  location.href = 'index.html';
});

</script>
</body>
</html>

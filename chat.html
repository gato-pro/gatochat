<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Private chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071428,#041022);color:#fff;font-family:Inter}
.header{display:flex;align-items:center;gap:12px;padding:14px;background:rgba(255,255,255,0.02)}
.back{background:transparent;border:none;color:#9bd;cursor:pointer}
.container{display:flex;flex-direction:column;height:calc(100dvh - 64px)}
.messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:75%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04)}
.msg.me{align-self:flex-end;background:linear-gradient(90deg,#4f46e5,#06b6d4);color:#fff}
.compose{display:flex;padding:12px;gap:8px;background:rgba(0,0,0,0.04)}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
.send{padding:10px 14px;border-radius:10px;border:none;background:#7c3aed;color:#fff;cursor:pointer}
.meta{font-size:12px;color:#9aa8bb;margin-bottom:6px}
@media (max-width:600px){.msg{max-width:90%}}
</style>
</head>
<body>

<div class="header">
  <button class="back" onclick="location.href='members.html'">←</button>
  <div>
    <div id="otherName" style="font-weight:700">Chat</div>
    <div id="otherStatus" style="font-size:12px;color:#9aa8bb">Connecting...</div>
  </div>
</div>

<div class="container">
  <div class="messages" id="messages"></div>

  <div class="compose">
    <input id="text" class="input" placeholder="Type a message..." />
    <button id="btnSend" class="send">Send</button>
  </div>
</div>

<!-- Firebase COMPAT SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* ---------------------- FIXED FIREBASE CONFIG ---------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBdhQFVF0PTZMw0DXT5zBLpxndw_HNSv5U",
  authDomain: "gatochat-56ab6.firebaseapp.com",
  projectId: "gatochat-56ab6",
  storageBucket: "gatochat-56ab6.firebasestorage.app",
  messagingSenderId: "888124564246",
  appId: "1:888124564246:web:33a41ee68eec0f6b9c2637",

  /* THIS WAS MISSING / REQUIRED FOR MESSAGES */
  databaseURL: "https://gatochat-56ab6-default-rtdb.firebaseio.com"
};
/*--------------------------------------------------------------------*/

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ---------------- URL PARAMS ---------------- */
function qs(n){ return new URLSearchParams(location.search).get(n); }
const chatId = qs('chatId');
const other = qs('other');
if(!chatId || !other) location.href='members.html';

/* ---------------- MAIN ---------------- */
auth.onAuthStateChanged(u => {
  if(!u) location.href='login.html';
  else initChat(u);
});

async function initChat(user){
  const messagesEl = document.getElementById('messages');
  const otherNameEl = document.getElementById('otherName');
  const otherStatusEl = document.getElementById('otherStatus');

  /* -------- LOAD OTHER USER NAME -------- */
  const otherSnap = await db.ref('users/'+other).once('value');
  const otherData = otherSnap.val() || {};
  otherNameEl.innerText = otherData.name || "User";

  /* -------- LIVE PRESENCE ---------- */
  db.ref('presence/'+other).on('value', snap => {
    const p = snap.val();
    if(p && p.online) otherStatusEl.innerText = "Online";
    else otherStatusEl.innerText = "Last seen: " + (p ? new Date(p.lastSeen).toLocaleString() : "Unknown");
  });

  /* -------- LOAD OLD MESSAGES FIRST -------- */
  db.ref(`privateChats/${chatId}/messages`)
    .orderByChild("time")
    .once("value", snap => {
      messagesEl.innerHTML = "";
      snap.forEach(c => renderMsg(c.val(), user.uid));
      autoScroll();
    });

  /* -------- REALTIME NEW MESSAGES -------- */
  db.ref(`privateChats/${chatId}/messages`)
    .orderByChild("time")
    .on("child_added", snap => {
      renderMsg(snap.val(), user.uid);
      autoScroll();
    });

  /* -------- SEND MESSAGE -------- */
  document.getElementById('btnSend').onclick = async () => {
    const text = document.getElementById('text').value.trim();
    if(!text) return;

    await db.ref(`privateChats/${chatId}/messages`).push({
      sender: user.uid,
      text,
      time: Date.now()
    });

    document.getElementById('text').value = "";
  };
}

/* ---------------- RENDER MESSAGE ---------------- */
function renderMsg(m, myUid){
  const box = document.createElement("div");
  box.className = "msg"+(m.sender===myUid?" me":"");

  box.innerHTML = `
    <div class="meta">
      ${m.sender===myUid?"You":""} • ${new Date(m.time).toLocaleTimeString()}
    </div>
    <div>${escapeHtml(m.text)}</div>
  `;

  document.getElementById("messages").appendChild(box);
}

function autoScroll(){
  const el = document.getElementById("messages");
  el.scrollTop = el.scrollHeight;
}

/* Escape HTML */
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c=>(
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
  ));
}
</script>

</body>
</html>


<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Private Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root { --bg1:#071428; --bg2:#041022; --muted:#9aa8bb; }
body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;font-family:Inter}
.header{display:flex;align-items:center;gap:12px;padding:14px;background:rgba(255,255,255,0.02)}
.back{background:transparent;border:none;color:#9bd;cursor:pointer;font-size:18px}
.otherPic{width:40px;height:40px;border-radius:10px;object-fit:cover;background:#0b1220}
.container{display:flex;flex-direction:column;height:calc(100dvh - 64px)}
.messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column-reverse;gap:8px}
.msg{max-width:75%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);position:relative;word-break:break-word}
.msg.me{align-self:flex-end;background:linear-gradient(90deg,#090909,#070707);color:#fff}
.meta{font-size:12px;color:var(--muted);margin-bottom:4px}
.compose{display:flex;padding:12px;gap:8px;background:rgba(0,0,0,0.04)}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255, 255, 255, 0.593);background:transparent;color:#fff;min-height:42px;resize:none}
.send{border:none;background:transparent;color:#fff;cursor:pointer}
.replyBar { display:flex; flex-direction:row; align-items:center; border-left:4px solid #4f46e5; padding:6px 10px; margin:0 12px; margin-bottom:4px; background:rgba(255,255,255,0.05); border-radius:8px; }
.replyBarText { flex:1; font-size:14px; color:#d1d5db; }
.cancelReplyBtn { cursor:pointer; padding:6px 10px; color:#ff6b6b; }
.replyBubble { border-left:4px solid rgba(255,255,255,0.4); padding-left:6px; margin-bottom:6px; opacity:0.85; font-size:13px; }
#loadingOverlay { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;z-index:9999; display:none;}
</style>
</head>
<body>

<div id="loadingOverlay">Loading...</div>
<div id="replyPreviewHolder"></div>

<div class="header">
  <button class="back" onclick="location.href='members.html'">←</button>
  <img id="otherPic" class="otherPic" src="https://via.placeholder.com/80x80?text=?" />
  <div>
    <div id="otherName" style="font-weight:700">Chat</div>
    <div id="otherStatus" style="font-size:12px;color:#9aa8bb">Connecting...</div>
  </div>
</div>

<div class="container">
  <div class="messages" id="messages"></div>
  <div class="compose">
    <textarea id="text" class="input" placeholder="Type a message..." rows="1"></textarea>
    <button id="btnSend" class="send">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
        <path d="M9.61109 12.4L10.8183 18.5355C11.0462 19.6939 12.6026 19.9244 13.1565 18.8818L19.0211 7.84263C19.248 7.41555 19.2006 6.94354 18.9737 6.58417M9.61109 12.4L5.22642 8.15534C4.41653 7.37131 4.97155 6 6.09877 6H17.9135C18.3758 6 18.7568 6.24061 18.9737 6.58417M9.61109 12.4L18.9737 6.58417M19.0555 6.53333L18.9737 6.58417" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
    </button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBdhQFVF0PTZMw0DXT5zBLpxndw_HNSv5U",
  authDomain: "gatochat-56ab6.firebaseapp.com",
  databaseURL: "https://gatochat-56ab6-default-rtdb.firebaseio.com",
  projectId: "gatochat-56ab6",
  storageBucket: "gatochat-56ab6.firebasestorage.app",
  messagingSenderId: "888124564246",
  appId: "1:888124564246:web:33a41ee68eec0f6b9c2637"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const chatId = new URLSearchParams(location.search).get("chatId");
const other = new URLSearchParams(location.search).get("other");
let replyTarget = null, otherName = "User";
const imageCache = {}, BATCH_SIZE=30;
let oldestLoadedTime=null, loadingHistory=false;

const loadingEl = document.getElementById("loadingOverlay");
function showLoading(text="Loading..."){ loadingEl.style.display="flex"; loadingEl.textContent=text; }
function hideLoading(){ loadingEl.style.display="none"; }
function escapeHtml(x){ return x.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function scrollToBottom(){ const el=document.getElementById("messages"); el.scrollTop=el.scrollHeight; }
function preloadImage(uid,url){ if(!url||imageCache[uid]) return; const img=new Image(); img.src=url; imageCache[uid]=img; }

auth.onAuthStateChanged(u=>{
  if(!u) location.href="login.html";
  else { initPresence(u); initChat(u); }
});

function initChat(user){
  const messagesEl=document.getElementById("messages");
  const nameEl=document.getElementById("otherName");
  const statusEl=document.getElementById("otherStatus");
  const otherPicEl=document.getElementById("otherPic");

  const cachedPhoto = localStorage.getItem("photo_" + other);
  if(cachedPhoto) otherPicEl.src = cachedPhoto;

  db.ref("users/"+other).on("value",s=>{
    const val=s.val()||{};
    otherName = val.name||"User";
    nameEl.innerText = otherName;
    const photoUrl = val.photo || "https://via.placeholder.com/80x80?text=?";
    otherPicEl.src=photoUrl;
    preloadImage(other,photoUrl);
    localStorage.setItem("photo_" + other,photoUrl);
  });

  db.ref("presence/"+other).on("value",snap=>{
    const p=snap.val();
    statusEl.innerText=p?.online?"Online":"Last seen: "+new Date(p?.lastSeen||Date.now()).toLocaleString();
  });

  const rendered=new Set();
  const msgRef=db.ref(`privateChats/${chatId}/messages`);

  // Load latest 30 messages
  showLoading("Loading messages...");
  msgRef.orderByChild("time").limitToLast(BATCH_SIZE).once("value").then(snap=>{
    messagesEl.innerHTML="";
    const msgs=[];
    snap.forEach(c=>{ const d=c.val(); d.id=c.key; msgs.push(d); });
    msgs.forEach(m=>{ renderMsg(m,user.uid); markAsSeen(m.id,user.uid); rendered.add(m.id); });
    if(msgs.length) oldestLoadedTime=msgs[0].time;
    scrollToBottom();
    hideLoading();
  });

  // Infinite scroll to load older messages
  messagesEl.addEventListener("scroll",async function(){
    if(this.scrollTop===0 && !loadingHistory && oldestLoadedTime){
      loadingHistory=true; showLoading("Loading older messages...");
      const snap=await msgRef.orderByChild("time").endAt(oldestLoadedTime-1).limitToLast(BATCH_SIZE).once("value");
      const msgs=[]; snap.forEach(c=>{ const d=c.val(); d.id=c.key; msgs.push(d); });
      if(msgs.length===0){ oldestLoadedTime=null; loadingHistory=false; hideLoading(); return; }
      const scrollBefore=messagesEl.scrollHeight;
      msgs.reverse().forEach(m=>renderMsgAtTop(m,user.uid));
      oldestLoadedTime=msgs[0].time;
      loadingHistory=false;
      messagesEl.scrollTop=messagesEl.scrollHeight-scrollBefore;
      hideLoading();
    }
  });

  // Live new messages
  msgRef.orderByChild("time").startAt(Date.now()).on("child_added",snap=>{
    const m=snap.val(); m.id=snap.key;
    if(!rendered.has(m.id)){ renderMsg(m,user.uid); markAsSeen(m.id,user.uid); rendered.add(m.id); scrollToBottom(); }
  });

  // child_changed for ticks
  msgRef.on("child_changed",snap=>{
    const m=snap.val(); m.id=snap.key;
    const el=document.querySelector(`[data-msgid="${m.id}"]`);
    if(el) updateMsgTicks(el,m,user.uid);
  });

  // child_removed
  msgRef.on("child_removed",snap=>{
    const el=document.querySelector(`[data-msgid="${snap.key}"]`);
    if(el) if(el) el.innerHTML=`<div style="font-size:12px;color:#9aa8bb;">Message deleted</div>`;
  });

  // send handlers
  const input=document.getElementById("text");
  document.getElementById("btnSend").onclick=()=>sendMessage(user);
  input.onkeydown=(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(user); } }
}

/* ================= SEND MESSAGE ================= */
function sendMessage(user){
  const text=document.getElementById("text").value.trim();
  if(!text) return;
  const newMsg={sender:user.uid,senderName:user.displayName||"You",text,time:Date.now(),seenBy:[user.uid]};
  if(replyTarget) newMsg.reply={id:replyTarget.id,sender:replyTarget.sender,senderName:replyTarget.senderName,text:replyTarget.text};
  db.ref(`privateChats/${chatId}/messages`).push(newMsg);
  document.getElementById("text").value="";
  hideReplyPreview();
}

/* ================= MARK AS SEEN ================= */
function markAsSeen(msgId,userId){
  const seenRef=db.ref(`privateChats/${chatId}/messages/${msgId}/seenBy`);
  seenRef.once("value").then(snap=>{ let arr=snap.val()||[]; if(!arr.includes(userId)){ arr.push(userId); seenRef.set(arr); } });
}

/* ================= RENDER MESSAGE ================= */
function renderMsg(m,my){
  const box=document.createElement("div"); box.className="msg"+(m.sender===my?" me":""); box.dataset.msgid=m.id;
  let replyHtml="";
  if(m.reply){ replyHtml=`<div class="replyBubble"><div style="font-weight:600;">${m.reply.sender===my?"You":m.reply.senderName||otherName}</div><div style="opacity:0.8;">${escapeHtml(m.reply.text)}</div></div>`; }
  const senderName=m.sender===my?"You":m.senderName||otherName;
  const ticks=getTicks(m,my);
  box.innerHTML=`<div class="meta">${senderName} • ${new Date(m.time).toLocaleTimeString()} ${ticks}</div>${replyHtml}<div>${escapeHtml(m.text)}</div>`;
  enableMessageContext(box,m);
  document.getElementById("messages").appendChild(box);
}
function renderMsgAtTop(m,my){
  const box=document.createElement("div"); box.className="msg"+(m.sender===my?" me":""); box.dataset.msgid=m.id;
  let replyHtml=""; if(m.reply){ replyHtml=`<div class="replyBubble"><div style="font-weight:600;">${m.reply.sender===my?"You":m.reply.senderName||otherName}</div><div style="opacity:0.8;">${escapeHtml(m.reply.text)}</div></div>`; }
  const senderName=m.sender===my?"You":m.senderName||otherName; const ticks=getTicks(m,my);
  box.innerHTML=`<div class="meta">${senderName} • ${new Date(m.time).toLocaleTimeString()} ${ticks}</div>${replyHtml}<div>${escapeHtml(m.text)}</div>`;
  enableMessageContext(box,m);
  document.getElementById("messages").prepend(box);
}

/* ================= TICKS ================= */
function getTicks(m,my){ return (m.sender!==my)?"":(m.seenBy&&m.seenBy.includes(other)?"✔✔":"✔"); }
function updateMsgTicks(el,m,my){ const meta=el.querySelector(".meta"); if(meta){ meta.innerText=`${m.sender===my?"You":m.senderName||otherName} • ${new Date(m.time).toLocaleTimeString()} ${getTicks(m,my)}`; } }

/* ================= LONG PRESS MENU ================= */
let activeMenu=null;
function enableMessageContext(el,msg){
  let timer=null;
  el.addEventListener("contextmenu",e=>{ e.preventDefault(); showMenu(e.clientX,e.clientY,msg); });
  el.addEventListener("touchstart",e=>{ const t=e.touches[0]; timer=setTimeout(()=>showMenu(t.clientX,t.clientY,msg),600); });
  ["touchend","touchmove","touchcancel"].forEach(ev=>el.addEventListener(ev,()=>clearTimeout(timer)));
}
function showMenu(x,y,msg){
  hideMenu();
  const menu=document.createElement("div"); menu.className="ctxMenu"; menu.style.left=x+"px"; menu.style.top=y+"px";
  const btnReply=document.createElement("div"); btnReply.className="ctxBtn reply"; btnReply.innerText="Reply"; btnReply.onclick=()=>{ hideMenu(); showReplyPreview(msg); };
  const btnDelete=document.createElement("div"); btnDelete.className="ctxBtn delete"; btnDelete.innerText="Delete"; btnDelete.onclick=()=>{ hideMenu(); if(confirm("Delete this message?")) db.ref(`privateChats/${chatId}/messages/${msg.id}`).remove(); };
  const btnCancel=document.createElement("div"); btnCancel.className="ctxBtn cancel"; btnCancel.innerText="Cancel"; btnCancel.onclick=hideMenu;
  menu.appendChild(btnReply); menu.appendChild(btnDelete); menu.appendChild(btnCancel);
  document.body.appendChild(menu); activeMenu=menu; window.addEventListener("click",hideMenu);
}
function hideMenu(){ if(activeMenu){ activeMenu.remove(); activeMenu=null; window.removeEventListener("click",hideMenu); } }

/* ================= REPLY PREVIEW ================= */
function showReplyPreview(msg){ replyTarget={id:msg.id,sender:msg.sender,senderName:msg.senderName||otherName,text:msg.text};
  const holder=document.getElementById("replyPreviewHolder");
  holder.innerHTML=`<div class="replyBar"><div class="replyBarText"><div style="font-weight:600;">Replying to ${replyTarget.sender===auth.currentUser.uid?"You":replyTarget.senderName}</div><div style="opacity:0.8;">${escapeHtml(msg.text)}</div></div><div class="cancelReplyBtn" onclick="hideReplyPreview()">✕</div></div>`;
}
function hideReplyPreview(){ replyTarget=null; document.getElementById("replyPreviewHolder").innerHTML=""; }

/* ================= PRESENCE ================= */
function initPresence(user){
  const uid=user.uid;
  const presenceRef=db.ref("presence/"+uid);
  const connectedRef=db.ref(".info/connected");
  connectedRef.on("value",snap=>{
    if(snap.val()===true){
      presenceRef.set({online:true,lastSeen:Date.now(),name:user.displayName||""});
      presenceRef.onDisconnect().set({online:false,lastSeen:Date.now(),name:user.displayName||""});
    }
  });
  setInterval(()=>{ presenceRef.update({lastSeen:Date.now()}); },60000);
}
</script>
</body>
</html>
